---
title: "Body sites microbiome in animal model: drug repurposing TB"
subtitle: "Figure 1A,C,D, Figure 3 and Figure 4"
author: "Aurea Simon-Soro and Kyle Bittinger"
date: "06/12/2020"
output:
  pdf_document: default
  html_document: default
---


```{r knitr setup, echo=FALSE}
### ================
###   knitr setup
### ================
library(knitr)
opts_chunk$set(
  tidy=FALSE,
  cache=TRUE,
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  dpi=100,
  fig.width=8,
  fig.height=8,
  fig.align = "center"
  )
```

<!-- R packages -->
```{r R packages, message=FALSE}
### ================
###   R packages
### ================
#This package will also help us more easily manipulate our data
library(magrittr)
library(qiimer)
library(pander)
#Analyses of Phylogenetics and Evolution package. Required for tree calculations to be used with phyloseq
library(ape)
#The vegan package provides tools for descriptive community ecology. It has most basic functions of diversity analysis, community ordination and dissimilarity analysis. In general, this package is used for Bray-Curtis and Jaccard analyses.
library(vegan)
library(usedist)
library(tidyverse)
library(tibble)
#The phyloseq package seeks to address issues with multiple microbiome analysis packages by providing a set of functions that internally manage the organizing, linking, storing, and analyzing of phylogenetic sequencing data. In general, this package is used for UniFrac analyses.
library(phyloseq)
#Pretty Venn disgrams
library(VennDiagram)
library(ggbeeswarm)
library(ggtern)
library(ggthemes)
library(reshape2)
library(kylemisc)
library(ggrepel)
library(ggsci)
```



<!-- resources -->
```{r resources}
### ================
###   R resources
### ================
source("/home/aurea/R_functions.R")
```


```{r}
### ===========================
###   define constants
### ===========================
### minimum reads threshold
min_reads <- 1000
### rarefying subsample size 
richness_subsample_size <- 1000
### number of samples threshold to show heatmap on the page
sample_threshold <- 100
### setwd
#fill in your project dir
# From Kyle:
# To keep the project self-contained, place the data inside the project
# directory and use relative paths.  Here, I put the files in inst/extdata.
# If this project ever turns into an R package, you can keep the data files
# right where they are.
#Aurea: Here I used only the TATSURO's study samples. (decided after kyle, Michel meeting)
root_dir <- "/home/aurea/Koo/Tatsuro.Study/QIIME2.Analysis/"
### mapping file path
mapping_file_fp <- file.path(root_dir, "MF_Tatsuro.txt")
### otu table file path
feature_table_fp <- file.path(root_dir, "feature-table.tsv")
### taxonomic assignment 
taxo_assignment_fp <- file.path(root_dir, "taxonomy.tsv")
### Bray-Curtis Dissimilarities file path
bc_fp <- file.path(root_dir, "bc_distance-matrix.tsv")
### faith
faith_fp <- file.path(root_dir, "alpha-diversity.tsv")
```

```{r}
study_group_levels <- c("PBS", "NPC", "TB", "NPC.TB")

sample_type_levels <- c("Oral Swab", "Dental Plaque", "Feces")
```


```{r, warning=F, message=F}
### ===========================
###   read in data
### ===========================
### read mapping file
s <- read_tsv(mapping_file_fp) %>%
  rename(SampleID = "#SampleID") %>%
  # Fix sequencing control samples
  mutate(SampleType = if_else(
    (study_group %in% "Contamination Control"), "Blank oral swab", SampleType)) %>%
  mutate(is_seq_control = is.na(HostSpecies)) %>%
  mutate(study_color = na_if(study_color, "Contamination Control")) %>%
  mutate(study_group = na_if(study_group, "Contamination Control")) %>%
  # Assign levels
  mutate(study_group = fct_relevel(study_group, study_group_levels)) %>%
  mutate(SampleType = fct_relevel(SampleType, sample_type_levels))
```


```{r message=FALSE}
### read otu table
assignments <- read_tsv(file=taxo_assignment_fp) %>%
  rename(Lineage = Taxon, OtuID = `Feature ID`) %>%
  do(bind_cols(., split_assignments(.$Lineage))) %>%
  mutate_at(taxonomic_ranks, str_remove, "[kpcofgs]__") %>%
  mutate_at(taxonomic_ranks, na_if, "") %>%
  mutate(Assignment = simplify_assignments(.[taxonomic_ranks]))
otu_counts <- readr::read_tsv(feature_table_fp, skip=1) %>%
  rename(OtuID = "#OTU ID") %>%
  gather(SampleID, Counts, -OtuID) %>%
  left_join(assignments, by="OtuID") %>%
  filter(!str_detect(Family, "mitochondria")) %>%
  filter(!str_detect(Class, "Chloroplast")) %>%
  filter(!str_detect(Kingdom, "Unassigned")) %>%
  filter(!str_detect(Kingdom, "Archaea")) %>%
  group_by(SampleID) %>%
  filter(sum(Counts) > 0)
if (!all(otu_counts$OtuID %in% assignments$OtuID)) {
  stop("Some OTUs not in taxonomic assignments table")
}
assignment_counts <- otu_counts %>%
  group_by(SampleID, Assignment) %>%
  summarize(Counts = sum(Counts)) %>%
  ungroup() %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup()
read_counts <- otu_counts %>%
  group_by(SampleID) %>%
  summarize(NumReads = sum(Counts))
```

No reads after contamination/archaea removal.

```{r, Samples error check 1}
### ===========================
###   check for missing samples
### ===========================
### possible issue 1: Samples found in the sample sheet but not in the feature table (0 reads)
s %>%
  filter(!(SampleID %in% read_counts$SampleID)) %>%
  select(SampleID, SampleType)
```

Samples in feature table but not sample info table.

```{r, Samples error check 2}
### possible issue 2: Samples found in the feature table but not in the sample sheet. There must be an error!
read_counts %>%
  filter(!(SampleID %in% s$SampleID))
```


```{r theme, include=FALSE}
theme_set(theme_classic() + theme(
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))) 
theme_boxplot <- function () {theme_base(base_size = 15) + 
                theme(line = element_line(size=0.8),
                text = element_text(size = 16),
                axis.text.x = element_text(color="black"),
                axis.text.y = element_text(color="black"),
                plot.background=element_blank())}
theme_figures <- function () {theme_kyle() +
                theme(line = element_line(size=0.8),
                text = element_text(size = 16),
                axis.text.x = element_text(color="black"),
                axis.text.y = element_text(color="black"),
                plot.background=element_blank())}
theme_scatterplot <- function () {theme_base(base_size = 12) + theme(
  line = element_line(size=0.8),
  text = element_text(face = "bold", color = "black"),
  axis.text.x = element_text(face="bold", color="black"),
  axis.text.y = element_text(face="bold", color="black"),
                plot.background=element_blank())}
```


```{r general quantification, include=FALSE}
## Whole samples that are above the `r min_reads` read count threshold
s %>%
  left_join(read_counts, by="SampleID") %>%
  mutate(NumReads = replace_na(NumReads, 0)) %>%
  mutate(Keep = if_else(NumReads > min_reads, "Keep", "Discard")) %>%
  count(SampleType, Keep) %>%
  spread(Keep, n) %>%
  pander()
```

```{r Color Palette, include=FALSE}
cols_group <- c("PBS" ="#24d968", "NPC"= "#ed31a7", "TB"= "#fead15", "NPC.TB" = "#0091c9")
cols_Site <- c("#6ad54a", "#4743c7", "#ae1c00")
cols_nestedness <- c("Feces only" = "#333333", "Oral Swab only" = "#6ad54a", "Dental Plaque only" = "#4743c7", "Both" = "#ae1c00", "Shared" = "#ae1c00")
```


```{r}
### ===========================
###   calculate / read in alpha diversity
### ===========================
faith_df <- read_tsv(file=faith_fp) %>%
  rename(SampleID=X1)
alpha_df <- otu_counts %>%
  group_by(SampleID) %>%
  summarize(
    Shannon = diversity(Counts),
    Richness = rarefy(Counts, 1000)) %>%
  left_join(faith_df, by="SampleID")
```

```{r}
# read in beta diversity
bc <- read_qiime_distmat(bc_fp)
```


# Overview

```{r, fig.width=6, fig.height=4, warning=F, include=FALSE}
## Histogram of high quality paired reads per sample
#The black dashed vertical line shows the minimum number of reads (`r min_reads`) for analysis. Control samples, if any, were included in the histogram.
s %>%
  left_join(read_counts, by="SampleID") %>%
  ggplot(aes(x=NumReads)) +
  geom_histogram(aes(fill=SampleType), binwidth=1000) +
  geom_vline(xintercept = min_reads, color="black", linetype="dashed") +
  scale_fill_d3() +
  labs(x="Number of reads", y="Number of samples") +
  theme_bw()
```


```{r}
s_sites <- s %>%
  left_join(read_counts, by="SampleID") %>%
  filter(NumReads > min_reads) %>%
  filter(study_group %in% c("PBS", "NPC", "TB", "NPC.TB"))
```

##Figure 1
###Fig 1A: Beta diversity body-site
```{r}
dist_fp <- bc_fp
dist_name <- "Bray-Curtis Unifrac distances"
```

The `r dist_name` was employed to compare the species composition of the samples to each other. We used a method of ordination called Principal Coordinates Analysis to select the best 2D coordinate system for display. The percentage in each axis represents the proportion of the total variance captured along the axis. 
```{r Obtain the proportion and axes for the main genera}
bc_sites <- dist_subset(bc, s_sites$SampleID)
# Here is the actual principal coordinates analysis
pc <- pcoa(bc_sites)
pctvar <- round(pc$values$Relative_eig * 100)
# Principal coordinate positions of samples
s_coords <- pc$vectors %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  select(1:4)
# Principal coordinate positions of taxa
taxa_coords <- assignment_counts %>%
  # Filter to include samples in this analysis
  right_join(s_coords, by="SampleID") %>%
  # Filter to keep high-abundance taxa
  group_by(Assignment) %>%
  filter(mean(Proportion) > 0.02) %>%
  ungroup() %>%
  # Weighted mean position along each axis
  gather(Axis, SamplePosition, starts_with("Axis")) %>%
  group_by(Assignment, Axis) %>%
  summarize(
    TaxonPosition = weighted.mean(SamplePosition, Proportion),
    MeanProp = mean(Proportion)) %>%
  ungroup() %>%
  spread(Axis, TaxonPosition) %>%
  # Make the labels nicer
  mutate(TaxonLabel = str_remove(Assignment, "^\\w+ "))
```


```{r Plot PCoA Body.sites, fig.width=7, fig.height=5}
s_sites %>%
  left_join(s_coords, by="SampleID") %>%
  ggplot(aes(x=Axis.1, y=Axis.2)) +
  geom_point(
    aes(fill=SampleType), shape= 21, size=5) +
  scale_fill_manual(values = cols_Site) +
  geom_text_repel(
    aes(label=TaxonLabel), fontface = 'bold.italic',
    data=taxa_coords, segment.size=0) +
  stat_ellipse(aes(group=SampleType)) +
  labs(
    x=paste0("PC1 (", pctvar[1], "%)"),
    y=paste0("PC2 (", pctvar[2], "%)"),
     fill="") +
   theme_scatterplot() +
  theme(text = element_text(size = 16))  +
  xlim(-0.7, 0.7) +
  ylim(-0.7, 0.7)
 
```

```{r test, include=FALSE}
source("/home/aurea/Function.Pairwise.Adonis.dm.R")
fstats_df <- pairwise.adonis.dm(bc_sites, s_sites$SampleType)
fstats_df
```

###Fig 1B: Richness
```{r, fig.height=3.5, fig.width=4}
s_sites %>%
  mutate(SampleType = str_replace(SampleType, " ", "\n")) %>%
  mutate(SampleType = fct_relevel(SampleType, "Oral\nSwab")) %>%
  left_join(alpha_df, by="SampleID") %>%
  ggplot(aes(x=SampleType, y=Richness)) +
  geom_boxplot(outlier.shape = NA) +
  geom_beeswarm(aes(color=SampleType), alpha=0.5) +
  scale_color_manual(values = cols_Site, guide=FALSE) +
  labs(x="", y="Richness\n(1k reads per sample)") +
  theme_boxplot()
```

```{r}
s_sites %>%
  left_join(alpha_df, by="SampleID") %>%
  with(pairwise.wilcox.test(
    Richness, SampleType, p.adjust.method = "bonferroni"))
```

### Fig 1D (upper panel: Rat)
Rat and human body-site differences
```{r fig.height=2, fig.width=5}
fstats_df %>%
  ggplot() +
  geom_col(aes(x=pairs, y=R2, fill=pairs)) +
  scale_fill_manual(values = cols_Site, guide=FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  coord_flip() +
  labs(x="", y=parse(text='R^2')) +
  theme_boxplot()
#ggsave("inst/figures/sites_r2.pdf", width=5, height=2)
```

###Fig S1: Alpha Diversity
Diversity: Shannon index
```{r, fig.height=3, fig.width=3}

  s_sites %>%
  mutate(SampleType = str_replace(SampleType, " ", "\n")) %>%
  mutate(SampleType = fct_relevel(SampleType, "Oral\nSwab")) %>%
  left_join(alpha_df, by="SampleID") %>%
  ggplot(aes(x=SampleType, y=Shannon)) +
  geom_boxplot(outlier.shape = NA) +
  geom_beeswarm(aes(color=SampleType), alpha=0.5) +
  scale_color_manual(values = cols_Site, guide=FALSE) +
  labs(x="", y="Shannon Index") +
  theme_boxplot()
```


```{r}
s_sites %>%
  left_join(alpha_df, by="SampleID") %>%
  with(pairwise.wilcox.test(
    Shannon, SampleType, p.adjust.method = "bonferroni"))
```

Faith Phylogenetic diversity 
```{r, fig.height=3, fig.width=3}
  s_sites %>%
  mutate(SampleType = str_replace(SampleType, " ", "\n")) %>%
  mutate(SampleType = fct_relevel(SampleType, "Oral\nSwab")) %>%
  left_join(alpha_df, by="SampleID") %>%
  ggplot(aes(x=SampleType, y=faith_pd)) +
  geom_boxplot(outlier.shape = NA) +
  geom_beeswarm(aes(color=SampleType), alpha=0.5) +
  scale_color_manual(values = cols_Site, guide=FALSE) +
  labs(x="", y="Faith PD") +
  theme_boxplot()
```

```{r}
s_sites %>%
  left_join(alpha_df, by="SampleID") %>%
  with(pairwise.wilcox.test(
    faith_pd, SampleType, p.adjust.method = "bonferroni"))
```

##Fig 3 Metadata PLOTS
###Fig 3B: Caries levels 
```{r}
cariesdata <- melt(s_sites,id.vars=c('study_group', 'SampleID', 'SampleType'), measure.vars=c('Caries.Ds', 'Caries.Dm', 'Caries.Dx'), variable.name="Caries", value.name="Counts") %>%
 filter(SampleType=="Dental Plaque")

# Change names of categories to be more self-explanatory
lookup <- c("Caries.Ds"="Initial Caries", "Caries.Dm"="Moderate Caries", "Caries.Dx"="Severe Caries")


# Calculates mean, sd, se and IC
my_sum.caries <- cariesdata %>%
  mutate(Caries=lookup[as.character(Caries)]) %>%
  na.omit(.) %>%
  group_by(Caries, study_group) %>%
  summarise( 
    n=n(),
    mean=mean(Counts),
    sd=sd(Counts)
  ) %>%
  mutate(se=sd/sqrt(n))  %>%
  mutate(ic=se * qt((1-0.05)/2 + .5, n-1))
```


```{r Caries PLOT, fig.height=3, fig.width=7}
ggplot(my_sum.caries, aes(Caries, mean, fill=study_group)) +
  geom_bar(stat = "identity", position = position_dodge(width=0.9)) +
  geom_errorbar(aes(x=Caries, ymin=mean-sd, ymax=mean+sd),
    width=0.2, position=position_dodge(width=0.9), alpha=0.9, size=0.5) +
  scale_fill_manual(values = cols_group) +
  theme_boxplot() +
  facet_grid(~Caries, scales = "free") + 
  labs(y= "Caries", x= "", fill="", title= "Dental Caries")  +
  theme(plot.title = element_text(hjust = 0.5, size = 14, color = "black", face = "bold"), strip.text.x = element_blank())

ggsave(
  "Figures/S2A.taxa.pdf",
  width=7, height=3, useDingbats=F)
ggsave(
  "Figures/S2A.taxa.png",
  width=7, height=3, dpi=200)
  
#Stats   
cariesdata %>%
  filter(Caries=="Caries.Dm") %>%
  with(pairwise.t.test(
    Counts, study_group))
```


###Fig 3C: CFUs 
S. mutans and C. albicans colony forming units per ml of dental plaque

```{r}
CFUdata <- melt(s_sites,id.vars=c('study_group', 'SampleID','SampleType'), measure.vars=c('S.mutans_CFU.ml', 'C.albicans_CFU.ml'), variable.name="CFU", value.name="Counts") %>%
 filter(SampleType=="Dental Plaque") #Filter the data only dental plaque samples

# Calculates mean, sd, se and IC
my_sum <- CFUdata %>%
  na.omit(.) %>%
  group_by(CFU, study_group) %>%
  summarise( 
    n=n(),
    mean=mean(Counts),
    sd=sd(Counts)
  ) %>%
  mutate( se=sd/sqrt(n))  %>%
  mutate( ic=se * qt((1-0.05)/2 + .5, n-1))

```


```{r CFU PLOT, fig.height=3, fig.width=6}
ggplot(my_sum, aes(CFU, mean, fill=study_group)) +
  geom_bar(stat = "identity", position = position_dodge(width=0.9)) +
  geom_errorbar(aes(x=CFU, ymin=mean-sd, ymax=mean+sd),
    width=0.2, position=position_dodge(width=0.9), alpha=0.9, size=0.5) +
  scale_fill_manual(values = cols_group) +
  theme_boxplot() +
  scale_y_log10() +
  facet_grid(~CFU, scales = "free") + 
   labs(y= "CFUs/ml", x= "", fill="", title= "Infection Level")  +
  theme(plot.title = element_text(hjust = 0.5, size = 14, color = "black", face = "bold"), strip.text.x = element_blank())

ggsave(
  "Figures/S2B.Infection.pdf",
  width=6, height=3, useDingbats=F)
ggsave(
  "Figures/S2B.Infection.png",
  width=6, height=3, dpi=200)
```



##Figure 3
###Fig 3A: Taxa
Bacteria with more than 1% mean relative abundance
```{r}
taxa <- assignment_counts %>%
  filter(SampleID %in% s_sites$SampleID) %>%
  mutate(Assignment = fct_lump(Assignment, n=10, w=Proportion)) %>%
  # Sum in each sample
  group_by(SampleID, Assignment) %>%
  summarize(Proportion = sum(Proportion)) %>%
  ungroup() %>%
  # Average within groups
  left_join(s_sites, by="SampleID") %>%
  group_by(SampleType, study_group, Assignment) %>%
  summarize(Proportion = mean(Proportion)) %>%
  ungroup()

mean_taxa <- taxa %>%
  group_by(SampleType, Assignment) %>%
  summarize(Proportion=mean(Proportion))
```


```{r Bar Plot Taxa, fig.height=5, fig.width=10}
taxa %>%
  ggplot(aes(x=study_group, y=Proportion)) +
  geom_col(aes(fill = Assignment)) +
  labs(x= "Treatment", y= "Bacterial Abundance") +
  ggsci::scale_fill_d3(palette = c("category20")) +
  labs(x="", y="Relative Abundance", fill="Bacteria") +
  theme_boxplot() +
  facet_grid(~SampleType, scales= "free") +
  theme(text = element_text(size = 16),
      strip.text.x = element_text(
      size = 16, color = "black", face = "bold"))
ggsave(
  "Figures/3A.taxa.pdf",
  width=10, height=5, useDingbats=F)
ggsave(
  "Figures/3A.taxa.png",
  width=10, height=5, dpi=200)
```


###Fig 3B: Fold-change estimate
```{r}
library(nlme)
tidy_lmer <- function(lmer_test) {
  mod <- summary(lmer_test)
  data.frame(term  = rownames(mod$tTable), mod$tTable, row.names=NULL)
}
```

```{r}

# # The formula you would like to test. One example is "props_logit ~ study_group"
#rep_mes_form # This is the repeated measures formula. Most likely it will be something like "~1|SubjectID"
library(broom)
summaries_df <- assignment_counts %>%
    filter(SampleID %in% s_sites$SampleID) %>%
    mutate(Assignment = fct_lump(Assignment, n=10, w=Proportion)) %>%
    mutate(Proportion = Proportion + 1e-6) %>%
    mutate(props_logit = log(Proportion/(1-Proportion))) %>%
    left_join(select(s_sites, SampleID, study_group, SampleType), by="SampleID") %>%
    group_by(Assignment, SampleType) %>%
    do(tidy(lm(as.formula(props_logit ~ study_group), data=.))) %>%
    ungroup() %>%
    filter(term != '(Intercept)') %>%
    filter(Assignment != "Other") %>%
    group_by(term, SampleType) %>%
    mutate(fdr = p.adjust(p.value, method="BH")) %>%
    ungroup() 

```

```{r Plot Fold-change, fig.height=5, fig.width=11}
#Color consistent with study_groups above
cols_est <- c("study_groupNPC"= "#ed31a7", "study_groupTB"= "#fead15", "study_groupNPC.TB" = "#0091c9")

library(ggpubr) 

## Getting the estimate and standard error from linear models (reduces to t-test with only 2 groups)
df2 <- summaries_df %>% mutate(Xn=as.numeric(Assignment))
summaries_df %>%
       mutate(Assignment = fct_reorder(Assignment, estimate)) %>%
       ggdotchart(x = "Assignment", y = "estimate",
           color = "term",   # Color by groups
           palette = cols_est, # Custom color palette
           sorting = "descending",                       # Sort value in descending order
           add = "segments",
           add.params = list(color = "lightgray", size = 1.5),# Add segments from y = 0 to dots
           rotate = TRUE,                                # Rotate vertically
           group = "SampleType",                                # Order by groups
           dot.size = 6,  # Large dot size
           shape = "SampleType"
           ) +
        geom_hline(yintercept=0, lty=2) +
        theme_boxplot() +
        scale_y_continuous(breaks=c(-5, 0, 5)) +
        theme(text = element_text(size = 16),
          strip.text.x = element_text(
          size = 16, color = "black", face = "bold")) +
        labs(y="Estimated difference in taxon abundance", x="", color="", shape="") +
        theme(panel.spacing = unit(1, "lines")) + #increase distance between facet_plots
        facet_grid(.~SampleType) +
        guides(shape=FALSE) +
        scale_x_discrete(position = "left")

ggsave(
  "Figures/3B.fold-change.pdf",
  width=11, height=5, useDingbats=F)
ggsave(
  "Figures/3B.fold-change.png",
  width=11, height=5, dpi=200)
       
```



###Fig 3C: Beta diversity
Bray-Curtis distances
```{r Preparing the data}
make_body_site_pcoa <- function (sample_type) {
  s_temp <- s_sites %>%
    filter(SampleType %in% sample_type)
  bc_temp <- dist_subset(bc, s_temp$SampleID)
  pc <- pcoa(bc_temp)
  pctvar <- round(pc$values$Relative_eig * 100)
  coords <- pc$vectors %>%
    as.data.frame() %>%
    rownames_to_column("SampleID") %>%
    select(1:4)
  s_temp %>%
  left_join(coords, by="SampleID") %>%
    ggplot(aes(x=Axis.1, y=Axis.2)) +
    geom_point(aes(fill=study_group), shape= 21, size=5) +
    scale_fill_manual(values= cols_group) +
    labs(
      x=paste0("PC1 (", pctvar[1], "%)"),
      y=paste0("PC2 (", pctvar[2], "%)"),
      fill="Treatment") +
    ggtitle(sample_type) +
    theme_boxplot() +
    theme(plot.title = element_text(hjust = 0.5, size = 14, color = "black", face = "bold"))
}
```

```{r PLOT PCoA, fig.height=3, fig.width=8}
p1 <- make_body_site_pcoa("Oral Swab")
p2 <- make_body_site_pcoa("Dental Plaque")
p3 <- make_body_site_pcoa("Feces")
ggpubr::ggarrange(p1, p2, p3, ncol = 3, nrow = 1, common.legend = TRUE)

ggsave(
  "Figures/3C.PCoA.pdf",
  width=8, height=3, useDingbats=F)
ggsave(
  "Figures/3C.PCoA.png",
  width=8, height=3, dpi=200)
```



```{r PCOA stats}
test_body_site_dist <- function (sample_type) {
  s_temp <- s_sites %>%
    filter(SampleType %in% sample_type)
  bc_temp <- dist_subset(bc, s_temp$SampleID)
  res <- adonis(bc_temp ~ study_group, data=s_temp)
  res$aov.tab %>%
    as_tibble(rownames="Term")
}
tibble(body_site = sample_type_levels) %>%
  group_by(body_site) %>%
  do(test_body_site_dist(.$body_site)) %>%
  filter(Term %in% "study_group") %>%
  rename(Pvalue = `Pr(>F)`) %>%
  select(Term, R2, Pvalue)
```


##Nestedness and turnover
```{r}
s_nest <- s_sites %>%
  droplevels()
```

```{r}
s_nest %>%
  xtabs(~ study_group + SampleType, data = .)
```

```{r}
s_nest %>% xtabs(~ SampleType + Cage.N, data=.)
```

```{r}
cage_groups <- s_nest %>%
  count(Cage.N, study_group) %>%
  select(-n)

sample_types <- s_nest %>%
  select(SampleID, SampleType)
```


```{r}
library(betapart)
pres_nest <- otu_counts %>%
  mutate(Present = as.numeric(Counts > 0)) %>%
  right_join(s_nest, by="SampleID") %>%
  group_by(OtuID) %>%
  #filter(sum(Present) > 0) %>%
  ungroup() %>%
  usedist::pivot_to_numeric_matrix(SampleID, OtuID, Present)
jacc_nest <- beta.pair(pres_nest, index.family = "jaccard")
```

### Within cage
```{r}
type_label_levels <- c(
  "Oral Swab - Dental Plaque",
  "Oral Swab - Feces",
  "Dental Plaque - Feces")

jne_cage <- jacc_nest$beta.jne %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$Cage.N) %>%
  filter(Group1 == Group2) %>%
  mutate(Component = "Nestedness")

jtu_cage <- jacc_nest$beta.jtu %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$Cage.N) %>%
  filter(Group1 == Group2) %>%
  mutate(Component = "Turnover")

jac_cage <- jacc_nest$beta.jac %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$Cage.N) %>%
  filter(Group1 == Group2) %>%
  mutate(Component = "Total")

jacc_nest_cage <- bind_rows(jne_cage, jtu_cage, jac_cage) %>%
  arrange(Item1, Item2, Component) %>%
  rename(Cage.N = Group1) %>%
  select(-Group2, -Label) %>%
  left_join(sample_types, by=c(Item1="SampleID")) %>%
  rename(Type1 = SampleType) %>%
  left_join(sample_types, by=c(Item2="SampleID")) %>%
  rename(Type2 = SampleType) %>%
  mutate(TypeLabel = paste(Type2, "-", Type1)) %>%
  mutate(TypeLabel = str_replace(
    TypeLabel, "Feces - Dental Plaque", "Dental Plaque - Feces")) %>%
  mutate(TypeLabel = fct_relevel(TypeLabel, type_label_levels)) %>%
  left_join(cage_groups, by="Cage.N") %>%
  mutate(study_group = fct_relevel(study_group, study_group_levels)) %>%
  group_by(Item1, Item2) %>%
  ungroup() %>%
  mutate(hasTB = str_detect(study_group, "TB")) %>%
  mutate(hasNPC = str_detect(study_group, "NPC")) %>%
  mutate(Component = fct_relevel(
    Component, c("Nestedness", "Turnover", "Total")))
```

```{r}
jacc_nest_cage %>%
  mutate(study_group = fct_rev(study_group)) %>%
  ggplot() +
  geom_point(aes(y=study_group, x=Distance, color=Component)) +
  facet_grid(TypeLabel ~ Component, scales="free_x") +
  ggsci::scale_color_jama(guide=F) +
  labs(x="Component of Jaccard distance", y="", color="") +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(angle=0, hjust = 0),
    panel.spacing.x = unit(2, "lines")) +
  theme_boxplot()
ggsave(
  "Figures/sites_cage_nestedness.pdf",
  width=8, height=3, useDingbats=F)
ggsave(
  "Figures/sites_cage_nestedness.png",
  width=8, height=3, dpi=200)
```
##Figure 4D:Nestedness by treatment
```{r}
jacc_nest_cage %>%
  filter(Component %in% "Nestedness") %>%
  filter(str_detect(TypeLabel, "Feces")) %>%
  mutate(study_group = fct_rev(study_group)) %>%
  ggplot() +
  geom_point(aes(y=study_group, x=Distance, color=study_group), size= 3) +
  facet_grid( ~ TypeLabel) +
  scale_color_manual(values= cols_group, guide=F) +
  scale_x_continuous(breaks = c(0, 0.1, 0.2, 0.3)) +
  labs(x="Nestedness of bacterial community", y="", color="") +
  theme_boxplot() +
   theme(
    strip.background = element_blank(),
    strip.text.y = element_text(angle=0, hjust = 0),
    panel.spacing.x = unit(2, "lines")) +
   theme(text = element_text(size = 16),
          strip.text.x = element_text(
          size = 16, color = "black", face = "bold")) 

ggsave(
  "Figures/sites_figure4d.pdf",
  width=7, height=3, useDingbats=F)
ggsave(
  "Figures/sites_figure4d.png",
  width=7, height=3, dpi=200)
```

```{r}
logit <- function (x, base = 10, impute = 1e-5) {
  x <- if_else(x <= 0, impute, x)
  x <- if_else(x >= 1, 1 - impute, x)
  log(x / (1 - x), base = base)
}
jacc_nest_cage_lm <- jacc_nest_cage %>%
  group_by(TypeLabel, Component) %>%
  do(broom::tidy(lm(logit(Distance + 1e-5) ~ hasTB + hasNPC, data=.))) %>%
  #filter(!(term %in% "(Intercept)")) %>%
  mutate(term = str_remove(term, "^has")) %>%
  mutate(term = str_remove(term, "TRUE$"))
```


### Within site
```{r}
jne_df <- jacc_nest$beta.jne %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$SampleType) %>%
  mutate(Component = "Nestedness")

jtu_df <- jacc_nest$beta.jtu %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$SampleType) %>%
  mutate(Component = "Turnover")

jac_df <- jacc_nest$beta.jac %>%
  usedist::dist_subset(s_nest$SampleID) %>%
  usedist::dist_groups(s_nest$SampleType) %>%
  mutate(Component = "Total")

jacc_nest_df <- bind_rows(jne_df, jtu_df) %>%
  arrange(Item1, Item2, Component) %>%
  group_by(Item1, Item2) %>%
  mutate(TotalDistance = sum(Distance)) %>%
  mutate(FractDistance = Distance / TotalDistance) %>%
  ungroup()

sample_group_levels <- c(
  "Within Oral Swab",
  "Within Dental Plaque",
  "Within Feces",
  "Between Oral Swab and Dental Plaque",
  "Between Dental Plaque and Feces",
  "Between Oral Swab and Feces")
```


```{r}
bind_rows(jne_df, jtu_df, jac_df) %>%
  mutate(Label = fct_relevel(Label, rev(sample_group_levels))) %>%
  mutate(Component = fct_relevel(Component, "Nestedness", "Turnover")) %>%
  mutate(Component = fct_recode(
    Component,
    "Nestedness component" = "Nestedness",
    "Turnover component" = "Turnover",
    "Total Jaccard distance" = "Total")) %>%
  ggplot() +
  geom_boxplot(aes(x=Label, y=Distance)) +
  facet_grid(~ Component) +
  coord_flip() +
  scale_y_continuous(breaks = c(seq(0, 1, by=0.5))) +
  labs(x="", y="", title="Components of Jaccard distance") +
  theme(strip.background = element_blank())
ggsave("Figures/sites_nestedness.pdf", width=10, height=4, useDingbats=F)
```

##Shared species

###Oral swab - Dental plaque
```{r}
subj_pairs <- s_sites %>%
  filter(!(SampleType %in% "Feces")) %>%
  pivot_wider(
    id_cols = SubjectID,
    names_from = SampleType,
    values_from = SampleID) %>%
  filter(!is.na(`Dental Plaque`), !is.na(`Oral Swab`)) %>%
  pivot_longer(
    -SubjectID, names_to = "SampleType", values_to = "SampleID") %>%
  select(SampleID)
```

```{r}
last_word <- function (x) {
  x %>%
    str_split(" ") %>%
    vapply(function (y) y[length(y)], "hello")
}
paired_props <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Dental Plaque")) %>%
  right_join(subj_pairs, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    SubjectID, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = fct_lump(last_word(Assignment), n=12, w=Proportion)) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  filter(((`Dental Plaque` > 0) | (`Oral Swab` > 0))) %>%
  filter(!(AssignmentLabel %in% "Other"))

```

```{r}
oral_dental_taxa <- paired_props %>%
  count(Assignment) %>%
  select(-n)
```

####Fig S4A
```{r}
paired_props %>%
  mutate(`Oral Swab` = `Oral Swab` + 1e-5) %>%
  mutate(`Dental Plaque` = `Dental Plaque` + 1e-5) %>%
  ggplot() +
  geom_point(aes(
    x=`Oral Swab`, y=`Dental Plaque`, color = study_group), size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~ AssignmentLabel, ncol = 4) +
  scale_color_manual(values = cols_group) +
  #scale_shape_manual(values = c(16, 17, 1, 2)) +
  scale_x_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(
    x = "Abundance in paired oral swab sample",
    y = "Abundance in paired dental plaque sample") +
  theme_boxplot() +
  theme(strip.background = element_blank()) 
  

ggsave(
  "Figures/FigureS4A_OralDentalPaired.pdf",
  width=8.5, height=6.5, useDingbats=F)
ggsave(
  "Figures/FigureS4A_OralDentalPaired.png",
  width=8.5, height=6.5, dpi=200)
```

####Fig 4B left
```{r}
paired_props %>%
  filter(AssignmentLabel %in% c("Streptococcus", "Lactobacillus")) %>%
  mutate(AssignmentLabel = paste(AssignmentLabel, "ASVs")) %>%
  mutate(`Oral Swab` = `Oral Swab` + 1e-5) %>%
  mutate(`Dental Plaque` = `Dental Plaque` + 1e-5) %>%
  ggplot() +
  geom_point(aes(
    x=`Oral Swab`, y=`Dental Plaque`, color = study_group), size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~ AssignmentLabel, ncol = 1) +
  scale_color_manual(values = cols_group) +
  scale_x_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(
    x = "Abundance in paired \noral swab sample",
    y = "Abundance in paired dental plaque sample",
    color="") +
  theme_boxplot() 
  
ggsave(
 "Figures/Figure4b_DentalOral.pdf",
  width=4.5, height=5.5, useDingbats=F)
ggsave(
  "Figures/Figure4b_DentalOral.png",
  width=4.5, height=5.5, dpi=200)
```


```{r}
location_levels_swab = c("Oral swab only", "Both", "Dental plaque only")
paired_pres <- paired_props %>%
  filter(AssignmentLabel %in% c("Lactobacillus", "S24-7", "Streptococcus")) %>%
  mutate(Opres = `Oral Swab` > 0, Ppres = `Dental Plaque` > 0) %>%
  mutate(
    `Oral swab only` = Opres & (!Ppres),
    `Both` = Opres & Ppres,
    `Dental plaque only` = (!Opres) & Ppres) %>%
  select(-c(`Dental Plaque`, `Oral Swab`, Opres, Ppres)) %>%
  pivot_longer(
    c(`Dental plaque only`, `Oral swab only`, Both), 
    names_to = "Location", values_to = "Detected") %>%
  filter(Detected) %>%
  mutate(Location = fct_relevel(Location, location_levels_swab))
```

####Fig S3A
```{r}
shared_colors <- c("#333333", "#6ad54a", "#4743c7", "#ae1c00")

paired_pres %>%
  mutate(Location = fct_rev(Location)) %>%
  ggplot() +
  geom_bar(aes(x=SubjectID, fill=Location)) +
  facet_grid(
    AssignmentLabel ~ study_group, 
    scales = "free", space = "free_x") +
   scale_fill_manual(values = shared_colors[c(3, 1, 2)]) +
  labs(y="Number of ASVs", x="Sample ID", fill="") +
  theme(
    axis.text.x = element_blank(),
    strip.background = element_blank())
ggsave(
  "Figures/FigureS3.pdf",
  width=7, height=8, useDingbats=F)
ggsave(
  "Figures/FigureS3.png",
  width=7, height=8, dpi=200)
  
```

###Oral swab - Feces

```{r}
subj_pairs_feces <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Feces")) %>%
  pivot_wider(
    id_cols = Cage.N,
    names_from = SampleType,
    values_from = SampleID) %>%
  filter(!is.na(`Feces`), !is.na(`Oral Swab`)) %>%
  pivot_longer(
    -Cage.N, names_to = "SampleType", values_to = "SampleID") %>%
  select(SampleID)
paired_props_feces <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Feces")) %>%
  right_join(subj_pairs_feces, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    Cage.N, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = fct_lump(last_word(Assignment), n=12, w=Proportion)) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  filter(((`Feces` > 0) | (`Oral Swab` > 0))) %>%
  #mutate(AssignmentLabel = fct_lump(
  #  last_word(Assignment), n=12, w=`Oral Swab`)) %>%
  filter(!(AssignmentLabel %in% "Other"))
```


```{r}
oral_feces_taxa <- paired_props_feces %>%
  count(Assignment) %>%
  select(-n)
```

####Fig S4B
```{r}
paired_props_feces %>%
  mutate(`Oral Swab` = `Oral Swab` + 1e-5) %>%
  mutate(`Feces` = `Feces` + 1e-5) %>%
  ggplot() +
  geom_point(aes(
    x=`Oral Swab`, y=`Feces`, color = study_group), size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~ AssignmentLabel, ncol = 4) +
  scale_color_manual(values = cols_group) +
  scale_x_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(
    x = "Abundance in paired oral swab sample",
    y = "Abundance in paired fecal sample") +
  theme_boxplot() +
  theme(strip.background = element_blank()) 
 
ggsave(
  "Figures/FigureS4B_OralFecesPaired.pdf",
  width=8.5, height=6.5, useDingbats=F)
ggsave(
  "Figures/FigureS4B_props_OralFecesPaired.png",
  width=8.5, height=6.5, dpi=200)
```

####Fig 4B right
```{r}
paired_props_feces %>%
  filter(AssignmentLabel %in% c("Streptococcus", "Lactobacillus")) %>%
  mutate(AssignmentLabel = paste(AssignmentLabel, "ASVs")) %>%
  mutate(`Oral Swab` = `Oral Swab` + 1e-5) %>%
  mutate(`Feces` = `Feces` + 1e-5) %>%
  ggplot() +
  geom_point(aes(
    x=`Oral Swab`, y=`Feces`, color = study_group), size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~ AssignmentLabel, ncol = 1) +
  scale_color_manual(values = cols_group) +
  scale_x_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(
    x = "Abundance in paired \noral swab sample",
    y = "Abundance in paired fecal sample",
    color = "") +
  theme_boxplot() 
  #theme(strip.background = element_blank())
ggsave(
  "Figures/Figure4b_OralFeces.pdf",
  width=4.5, height=5.5, useDingbats=F)
ggsave(
  "Figures/Figure4b_OralFeces.png",
  width=4.5, height=5.5, dpi=200)
```

```{r}
location_levels = c("Shared", "Oral Swab only", "Feces only")
paired_pres_feces <- paired_props_feces %>%
  filter(AssignmentLabel %in% c(
    "S24-7", "Lactobacillus", "Sutterella", "Oscillospira", "Bacteroides")) %>%
  mutate(Fpres = Feces > 0, Opres = `Oral Swab` > 0) %>%
  mutate(
    `Shared` = Fpres & Opres,
    `Oral Swab only` = (!Fpres) & Opres,
    `Feces only` = Fpres & (!Opres)) %>%
  select(-c(Feces, `Oral Swab`, Fpres, Opres)) %>%
  pivot_longer(
    c(`Feces only`, `Oral Swab only`, Shared), 
    names_to = "Location", values_to = "Detected") %>%
  filter(Detected) %>%
  mutate(Location = fct_relevel(Location, location_levels))
```

####Fig S3B
```{r}
shared_colors <- c("#333333", "#6ad54a", "#4743c7", "#ae1c00")

paired_pres_feces %>%
  mutate(Location = fct_rev(Location)) %>%
  ggplot() +
  geom_bar(aes(x=Cage.N, fill=Location)) +
  facet_grid(AssignmentLabel ~ study_group, scales = "free", space = "free_x") +
   scale_fill_manual(values = shared_colors[c(4, 2, 1)]) +
  labs(y="Number of ASVs", x="Cage", fill="") +
  theme_boxplot() +
  theme(
    axis.text.x = element_blank(),
    strip.background = element_blank())
ggsave(
  "Figures/FigureS3B.pdf",
  width=7, height=8, useDingbats=F)
ggsave(
  "Figures/FigureS3B.png",
  width=7, height=8, dpi=200)
```

####Fig 4C
```{r}
shared_colors <- c("#333333", "#6ad54a", "#4743c7", "#ae1c00")

paired_pres_feces %>%
  droplevels() %>%
  count(AssignmentLabel, Cage.N, study_group, Location) %>%
  tidyr::complete(
    AssignmentLabel, nesting(study_group, Cage.N), Location) %>%
  mutate(n = replace_na(n, 0)) %>%
  filter(AssignmentLabel %in% "Sutterella") %>%
  mutate(Location = fct_rev(Location)) %>%
  ggplot() +
  geom_col(aes(x=Cage.N, y=n, fill=Location)) +
  facet_grid(AssignmentLabel ~ study_group, scales = "free") +
  scale_fill_manual(values = shared_colors[c(4, 2, 1)]) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
  labs(y="Number of Sutterella 16S\namplicon sequence variants", x="Sample pairs", fill="") +
  theme_boxplot() +
  theme(
    axis.text.x = element_blank(),
    strip.background = element_blank())

ggsave(
  "Figures/Figure4C.pdf",
   width=7, height=3, useDingbats=F)
ggsave(
  "Figures/Figure4C.png",
   width=7, height=3, dpi=200)
```



```{r}
library(lme4)
library(lmerTest)

tidy_lmer <- function (m) {
  tibble::rownames_to_column(as.data.frame(summary(m)$coefficients), "Term")
}
paired_pres_feces_glm <- paired_pres_feces %>%
  filter(Location %in% c("Feces only", "Shared")) %>%
  filter(!(AssignmentLabel %in% c("Oscillospira", "Bacteroides", "Lactobacillus"))) %>%
  mutate(hasTB = str_detect(study_group, "TB")) %>%
  mutate(hasNPC = str_detect(study_group, "NPC")) %>%
  group_by(AssignmentLabel) %>%
  do(
    tidy_lmer(glmer(Location ~ hasTB + hasNPC + (1|Cage.N), data=., family = "binomial"))) %>%
  ungroup() %>%
  rename(p.value = `Pr(>|z|)`, std.error = `Std. Error`, term = Term) %>%
  mutate(term = str_remove(term, "^has")) %>%
  mutate(term = str_remove(term, "TRUE$"))


paired_pres_feces_glm %>%
  mutate(sig = if_else(p.value < 0.05, "P < 0.05", "n.s.")) %>%
  mutate(Term = str_replace(term, "study_group", "PBS vs. ")) %>%
  filter(!(term %in% "(Intercept)")) %>%
  ggplot(aes(x=term, color=AssignmentLabel)) +
  geom_hline(yintercept=0, linetype="dashed", color="#555555") +
  geom_point(aes(y=Estimate, shape=sig)) +
  geom_linerange(aes(ymin = Estimate - std.error, ymax = Estimate + std.error)) +
  scale_shape_manual(values = c(1, 16)) +
  #scale_color_manual(values = paired_colors, guide=FALSE) +
  coord_flip() +
  facet_grid(AssignmentLabel ~ .) +
  labs(y="Estimated effect (log-fold change)", x="", shape="") +
  theme(
    strip.background = element_blank(), 
    strip.text.y = element_text(angle=0, hjust=0))

#ggsave(
#  "inst/figures/sites_taxon_pres_tb_feces_lm.pdf",
#  width=5, height=2, useDingbats=F)
#ggsave(
#  "inst/figures/sites_taxon_pres_tb_feces_lm.png",
#  width=5, height=2, dpi=200)
```



```{r}
library(lme4)
library(lmerTest)

tidy_lmer <- function (m) {
  tibble::rownames_to_column(as.data.frame(summary(m)$coefficients), "Term")
}
paired_pres_feces_glm <- paired_pres_feces %>%
  filter(Location %in% c("Feces only", "Shared")) %>%
  filter(!(AssignmentLabel %in% c("Oscillospira", "Bacteroides", "Lactobacillus"))) %>%
  mutate(hasTB = str_detect(study_group, "TB")) %>%
  mutate(hasNPC = str_detect(study_group, "NPC")) %>%
  group_by(AssignmentLabel) %>%
  do(
    tidy_lmer(glmer(Location ~ hasTB + hasNPC + (1|Cage.N), data=., family = "binomial"))) %>%
  ungroup() %>%
  rename(p.value = `Pr(>|z|)`, std.error = `Std. Error`, term = Term) %>%
  mutate(term = str_remove(term, "^has")) %>%
  mutate(term = str_remove(term, "TRUE$"))


paired_pres_feces_glm %>%
  mutate(sig = if_else(p.value < 0.05, "P < 0.05", "n.s.")) %>%
  mutate(Term = str_replace(term, "study_group", "PBS vs. ")) %>%
  filter(!(term %in% "(Intercept)")) %>%
  ggplot(aes(x=term, color=AssignmentLabel)) +
  geom_hline(yintercept=0, linetype="dashed", color="#555555") +
  geom_point(aes(y=Estimate, shape=sig)) +
  geom_linerange(aes(ymin = Estimate - std.error, ymax = Estimate + std.error)) +
  scale_shape_manual(values = c(1, 16)) +
  scale_color_manual(values = paired_colors, guide=FALSE) +
  coord_flip() +
  facet_grid(AssignmentLabel ~ .) +
  labs(y="Estimated effect (log-fold change)", x="", shape="") +
  theme(
    strip.background = element_blank(), 
    strip.text.y = element_text(angle=0, hjust=0))
ggsave(
  "inst/figures/sites_taxon_pres_tb_feces_lm.pdf",
  width=5, height=2, useDingbats=F)
ggsave(
  "inst/figures/sites_taxon_pres_tb_feces_lm.png",
  width=5, height=2, dpi=200)
```

###Dental Plaque - Feces

```{r}
subj_pairs_feces_plaque <- s_sites %>%
  filter(SampleType %in% c("Dental Plaque", "Feces")) %>%
  pivot_wider(
    id_cols = Cage.N,
    names_from = SampleType,
    values_from = SampleID) %>%
  filter(!is.na(`Feces`), !is.na(`Dental Plaque`)) %>%
  pivot_longer(
    -Cage.N, names_to = "SampleType", values_to = "SampleID") %>%
  select(SampleID)

paired_props_feces_plaque <- s_sites %>%
  filter(SampleType %in% c("Dental Plaque", "Feces")) %>%
  right_join(subj_pairs_feces_plaque, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    SubjectID, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = fct_lump(last_word(Assignment), n=12, w=Proportion)) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  filter(((`Dental Plaque` > 0) | (`Feces` > 0))) %>%
  filter(!(AssignmentLabel %in% "Other"))

paired_props_feces_plaque <- s_sites %>%
  filter(SampleType %in% c("Dental Plaque", "Feces")) %>%
  right_join(subj_pairs_feces_plaque, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    Cage.N, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = fct_lump(
    last_word(Assignment), n=12, w=`Proportion`)) %>%
  filter(!(AssignmentLabel %in% "Other")) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  filter(((`Feces` > 0) | (`Dental Plaque` > 0)))
```

```{r}
dental_feces_taxa <- paired_props_feces_plaque %>%
  count(Assignment) %>%
  select(-n)
```

```{r}
paired_props_feces_plaque %>%
  mutate(`Dental Plaque` = `Dental Plaque` + 1e-5) %>%
  mutate(`Feces` = `Feces` + 1e-5) %>%
  ggplot() +
  geom_point(aes(
    x=`Dental Plaque`, y=`Feces`, color = study_group), size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~ AssignmentLabel, ncol = 4) +
  scale_color_manual(values = cols_group) +
  #scale_shape_manual(values = c(16, 17, 1, 2)) +
  scale_x_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(
    labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(
    x = "Abundance in paired dental plaque sample",
    y = "Abundance in paired fecal sample") +
  theme_boxplot() +
  theme(strip.background = element_blank())

ggsave(
  "Figures/FigureS4C_FecesPlaquePaired.pdf",
  width=8.5, height=6.5, useDingbats=F)
ggsave(
  "Figures/FigureS4C_FecesPlaquePaired.png",
  width=8.5, height=6.5, dpi=200)
```

```{r}
location_levels_plaque = c("Feces only", "Both", "Dental plaque only")
paired_pres_feces_plaque <- paired_props_feces_plaque %>%
  filter(AssignmentLabel %in% c(
    "S24-7", "Lactobacillus", "Sutterella", "Allobaculum",
    "Bacteroides")) %>%
  mutate(Fpres = Feces > 0, Opres = `Dental Plaque` > 0) %>%
  mutate(
    `Feces only` = Fpres & (!Opres),
    `Both` = Fpres & Opres,
    `Dental plaque only` = (!Fpres) & Opres) %>%
  select(-c(Feces, `Dental Plaque`, Fpres, Opres)) %>%
  pivot_longer(
    c(`Feces only`, `Dental plaque only`, Both), 
    names_to = "Location", values_to = "Detected") %>%
  filter(Detected) %>%
  mutate(Location = fct_relevel(Location, location_levels_plaque))
```

####Fig S3C
```{r}
paired_pres_feces_plaque %>%
  mutate(Location = fct_rev(Location)) %>%
  ggplot() +
  geom_bar(aes(x=Cage.N, fill=Location)) +
  facet_grid(AssignmentLabel ~ study_group, scales = "free", space = "free_x") +
  scale_fill_manual(values = shared_colors[c(3, 1, 4)]) +
  labs(y="Number of ASVs", x="Cage", fill="") +
  theme_boxplot() +
  theme(
    axis.text.x = element_blank(),
    strip.background = element_blank())
ggsave(
  "Figures/FigureS3C.pdf",
  width=6, height=6, useDingbats=F)
ggsave(
  "Figures/FigureS3C.png",
  width=6, height=6, dpi=200)
```



```{r}

paired_pres_feces_plaque_glm <- paired_pres_feces_plaque %>%
  filter(Location %in% c("Feces only", "Both")) %>%
  filter(!(AssignmentLabel %in% c("Oscillospira", "Bacteroides"))) %>%
  mutate(hasTB = str_detect(study_group, "TB")) %>%
  mutate(hasNPC = str_detect(study_group, "NPC")) %>%
  group_by(AssignmentLabel) %>%
  do(
    tidy_lmer(glmer(Location ~ hasTB + hasNPC + (1|Cage.N), data=., family = "binomial"))) %>%
  ungroup() %>%
  rename(p.value = `Pr(>|z|)`, std.error = `Std. Error`, term = Term) %>%
  mutate(term = str_remove(term, "^has")) %>%
  mutate(term = str_remove(term, "TRUE$"))


paired_pres_feces_plaque_glm %>%
  mutate(sig = if_else(p.value < 0.05, "P < 0.05", "n.s.")) %>%
  mutate(Term = str_replace(term, "study_group", "PBS vs. ")) %>%
  filter(!(term %in% "(Intercept)")) %>%
  ggplot(aes(x=term, color=AssignmentLabel)) +
  geom_hline(yintercept=0, linetype="dashed", color="#555555") +
  geom_point(aes(y=Estimate, shape=sig)) +
  geom_linerange(aes(ymin = Estimate - std.error, ymax = Estimate + std.error)) +
  scale_shape_manual(values = c(1, 16)) +
  #scale_color_manual(values = paired_colors, guide=FALSE) +
  coord_flip() +
  facet_grid(AssignmentLabel ~ .) +
  labs(y="Estimated effect (log-fold change)", x="", shape="") +
  theme(
    strip.background = element_blank(), 
    strip.text.y = element_text(angle=0, hjust=0))
ggsave(
  "Figures/sites_taxon_pres_tb_feces_plaque_lm.pdf",
  width=5, height=2, useDingbats=F)
ggsave(
  "Figures/sites_taxon_pres_tb_feces_plaque_lm.png",
  width=5, height=2, dpi=200)
```

####Fig 4A:Sharing by taxon

Shared oral-plaque
Shared oral-fecal

```{r}
top_taxa_paired <- bind_rows(
  oral_dental_taxa, oral_feces_taxa) %>%
  distinct() %>%
  arrange(Assignment)
```

```{r}
site_classes <- tibble(
  SampleType = c(
    "Oral swab only", "Dental plaque only", "Feces only",
    "Oral swab and dental plaque", "Oral swab and feces",
    "Dental plaque and feces",
    "Oral swab, dental plaque, and feces"),
  SiteClass = rep(
    c("Single site", "Two sites", "All sites"),
    c(3, 3, 1)))
```

```{r}
oral_dental_asvs_shared <- paired_props %>%
  mutate(
    OralPres = `Oral Swab` > 0,
    PlaquePres = `Dental Plaque` > 0) %>%
  group_by(AssignmentLabel) %>%
  summarize(
    Shared = sum(OralPres & PlaquePres),
    `Oral Swab only` = sum(OralPres & !PlaquePres),
    `Other site only` = sum(!OralPres & PlaquePres),
    Total = n()) %>%
  mutate(Comparison = "Oral Swab - Dental Plaque")
```

```{r}
oral_dental_asvs_shared %>%
  with(chisq.test(matrix(c(Shared, Total - Shared), ncol=2)))
```



```{r}
oral_feces_asvs_shared <- paired_props_feces %>%
  mutate(
    OralPres = `Oral Swab` > 0,
    FecesPres = `Feces` > 0) %>%
  group_by(AssignmentLabel) %>%
  summarize(
    Shared = sum(OralPres & FecesPres),
    `Oral Swab only` = sum(OralPres & !FecesPres),
    `Other site only` = sum(!OralPres & FecesPres),
    Total = n()) %>%
  mutate(Comparison = "Oral Swab - Feces")
```



```{r}
shared_colors <- c("#333333", "#6ad54a", "#4743c7", "#ae1c00")
all_shared_taxa <- unique(c(
  as.character(oral_dental_asvs_shared$AssignmentLabel),
  as.character(oral_feces_asvs_shared$AssignmentLabel)))

oral_dental_asvs_shared_comb <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Dental Plaque")) %>%
  right_join(subj_pairs, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    SubjectID, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = last_word(Assignment)) %>%
  filter(AssignmentLabel %in% all_shared_taxa) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  mutate(
    OralPres = `Oral Swab` > 0,
    PlaquePres = `Dental Plaque` > 0) %>%
  group_by(AssignmentLabel) %>%
  summarize(
    Shared = sum(OralPres & PlaquePres),
    `Oral Swab only` = sum(OralPres & !PlaquePres),
    `Dental Plaque only` = sum(!OralPres & PlaquePres)) %>%
  pivot_longer(
    -AssignmentLabel, 
    names_to = "AsvType", values_to = "n") %>%
  mutate(Comparison = "Oral Swab - Dental Plaque")

oral_fecal_asvs_shared_comb <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Feces")) %>%
  right_join(subj_pairs_feces, by="SampleID") %>%
  left_join(otu_counts, by="SampleID") %>%
  group_by(SampleID) %>%
  mutate(Proportion = Counts / sum(Counts)) %>%
  ungroup() %>%
  select(
    Cage.N, SampleType, OtuID, Assignment,
    Proportion, project, study_group) %>%
  mutate(AssignmentLabel = last_word(Assignment)) %>%
  filter(AssignmentLabel %in% all_shared_taxa) %>%
  pivot_wider(
    names_from = SampleType, values_from = Proportion) %>%
  mutate(
    OralPres = `Oral Swab` > 0,
    FecesPres = `Feces` > 0) %>%
  group_by(AssignmentLabel) %>%
  summarize(
    Shared = sum(OralPres & FecesPres),
    `Oral Swab only` = sum(OralPres & !FecesPres),
    `Feces only` = sum(!OralPres & FecesPres)) %>%
  pivot_longer(
    -AssignmentLabel, 
    names_to = "AsvType", values_to = "n") %>%
  mutate(Comparison = "Oral Swab - Feces")


bind_rows(oral_dental_asvs_shared_comb, oral_fecal_asvs_shared_comb) %>%
  group_by(AssignmentLabel, Comparison) %>%
  mutate(p = n / sum(n)) %>%
  ungroup() %>%
  mutate(p_shared = ifelse(
    (AsvType %in% "Shared") & (Comparison %in% "Oral Swab - Dental Plaque"),
    p, 0)) %>%
  mutate(AssignmentLabel = fct_reorder(AssignmentLabel, p_shared, .fun = max)) %>%
  mutate(AsvType = fct_relevel(
    AsvType, "Shared", "Oral Swab only")) %>%
  ggplot() +
  geom_col(
    aes(x=AssignmentLabel, y=n, fill=AsvType),
    position = position_fill(reverse = TRUE)) +
  facet_grid(~ Comparison) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=shared_colors) +
  theme_boxplot() +
  labs(y="Percentage of 16S amplicon sequence\nvariants shared between body sites", x="", fill="") +
  theme(
    axis.text.y = element_text(face = "italic"),
    strip.background = element_blank(),
    panel.spacing = grid::unit(2, "lines"),
    strip.text.x = element_text(
          size = 16, color = "black", face = "bold")) 
  theme(strip.background = element_blank(), panel.spacing = grid::unit(2, "lines"))


ggsave(
  "Figures/Figure4A.pdf",
  width=10.5, height=5, useDingbats=F)
ggsave(
  "Figures/Figure4A.png",
  width=10.5, height=5, dpi=200)
```


```{r}
taxon_sites_present <- s_sites %>%
  filter(SampleType %in% c("Oral Swab", "Dental Plaque", "Feces")) %>%
  left_join(otu_counts, by="SampleID") %>%
  filter(Assignment %in% top_taxa_paired$Assignment) %>%
  mutate(Present = Counts > 0) %>%
  select(OtuID, Assignment, Cage.N, SampleType, Present) %>%
  pivot_wider(
    id_cols = c(OtuID, Cage.N, Assignment),
    names_from = SampleType, values_from = Present,
    values_fill = list(Present = FALSE)) %>%
  rename(Plaque = `Dental Plaque`, Oral = `Oral Swab`) %>%
  group_by(Assignment) %>%
  summarize(
    `Oral swab only` = sum(Oral & !Plaque & !Feces),
    `Dental plaque only` = sum(!Oral & Plaque & !Feces),
    `Feces only` = sum(!Oral & !Plaque & Feces),
    `Oral swab and dental plaque` = sum(Oral & Plaque & !Feces),
    `Oral swab and feces` = sum(Oral & !Plaque & Feces),
    `Dental plaque and feces` = sum(!Oral & Plaque & Feces),
    `Oral swab, dental plaque, and feces` = sum(
      Oral & Plaque & Feces)) %>%
  pivot_longer(-Assignment, names_to="SampleType", values_to = "n")
```

```{r}
taxon_sites_present %>%
  left_join(site_classes, by="SampleType") %>%
  ggplot() +
  geom_col(aes(x=Assignment, y=n, fill=SampleType)) +
  coord_flip()
```